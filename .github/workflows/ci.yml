name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: Build & Tag (CI Mode)
        run: make ci

      - name: Install Trivy
        run: |
          wget https://github.com/aquasec/trivy/releases/download/v0.48.3/trivy_0.48.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

      - name: Security Scan (Trivy)
        run: |
          # 1. Informational scan
          trivy image --exit-code 0 gemini-toolbox/cli:latest
          # 2. Gatekeeper scan (Fail on critical fixable)
          trivy image --severity CRITICAL --exit-code 1 --ignore-unfixed gemini-toolbox/cli:latest
          trivy image --severity CRITICAL --exit-code 1 --ignore-unfixed gemini-toolbox/cli-preview:latest
          trivy image --severity CRITICAL --exit-code 1 --ignore-unfixed gemini-toolbox/cli-full:latest

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Publish to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          REPO="${{ secrets.DOCKER_HUB_USER }}/gemini-toolbox"
          
          # --- Stable ---
          # Tags: :latest, :latest-stable, :X.Y.Z, :X.Y.Z-stable
          docker tag gemini-toolbox/cli:latest $REPO:latest
          docker tag gemini-toolbox/cli:latest $REPO:latest-stable
          docker push $REPO:latest
          docker push $REPO:latest-stable
          
          VERSION=$(docker run --rm --entrypoint="" gemini-toolbox/cli:latest gemini --version | tr -d '\r')
          docker tag gemini-toolbox/cli:latest $REPO:$VERSION
          docker tag gemini-toolbox/cli:latest $REPO:$VERSION-stable
          docker push $REPO:$VERSION
          docker push $REPO:$VERSION-stable

          # --- Preview ---
          # Tags: :latest-preview, :X.Y.Z-preview
          docker tag gemini-toolbox/cli-preview:latest $REPO:latest-preview
          docker push $REPO:latest-preview
          
          PREVIEW_VER=$(docker run --rm --entrypoint="" gemini-toolbox/cli-preview:latest gemini --version | tr -d '\r')
          docker tag gemini-toolbox/cli-preview:latest $REPO:$PREVIEW_VER-preview
          docker push $REPO:$PREVIEW_VER-preview

          # --- Full ---
          # Tags: :latest-full, :X.Y.Z-full
          docker tag gemini-toolbox/cli-full:latest $REPO:latest-full
          docker push $REPO:latest-full
          
          FULL_VER=$(docker run --rm --entrypoint="" gemini-toolbox/cli-full:latest gemini --version | tr -d '\r')
          docker tag gemini-toolbox/cli-full:latest $REPO:$FULL_VER-full
          docker push $REPO:$FULL_VER-full
