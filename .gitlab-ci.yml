include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - build
  - test

variables:
  DOCKER_IMAGE_NAME: gemini-cli
  DOCKER_IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# 1. Build the image and save it as an artifact
# This allows us to scan it in the next stage without pushing to a registry
build_image:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - cd images/gemini-cli
    - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG .
    - mkdir -p ../../dist
    - docker save -o ../../dist/image.tar $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
  artifacts:
    paths:
      - dist/image.tar
    expire_in: 1 hour

# 2. Security Scanning with Trivy
# Scans the built image for OS (Debian) and Application (Node) vulnerabilities
trivy_scan:
  stage: test
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  needs: ["build_image"]
  script:
    # Scan the saved tarball
    - trivy image --input dist/image.tar
    # Fail the pipeline only on CRITICAL vulnerabilities
    - trivy image --input dist/image.tar --severity CRITICAL --exit-code 1 --ignore-unfixed
