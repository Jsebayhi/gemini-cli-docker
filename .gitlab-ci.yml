include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - build
  - test

include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - build
  - test

variables:
  DOCKER_DRIVER: overlay2

# 1. Build the images and save them as artifacts
build_images:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - apk add --no-cache make
    # Use the new 'make ci' target (Builds + Tags with Version)
    - make ci
    - mkdir -p dist
    # Save all 3 variants into one tarball for transport
    - docker save -o dist/images.tar gemini-toolbox/cli:latest gemini-toolbox/cli-preview:latest gemini-toolbox/cli-full:latest
  artifacts:
    paths:
      - dist/images.tar
    expire_in: 1 hour

# 2. Security Scanning with Trivy
trivy_scan:
  stage: test
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  needs: ["build_images"]
  script:
    # Scan the tarball (Trivy will see all images inside)
    # 1. Report ALL vulnerabilities
    - trivy image --input dist/images.tar --exit-code 0
    # 2. Fail ONLY on CRITICAL fixable vulnerabilities
    - trivy image --input dist/images.tar --severity CRITICAL --exit-code 1 --ignore-unfixed
